{% macro afficherReponses(reponses, idAuteur, pseudoAuteur) %}
	{% for reponse in reponses %}
		<div class="card my-4 shadow-sm border-0 rounded-3 ms-5">
			<div class="card-body p-4 bg-mydark text-white rounded">
				<div class="d-flex align-items-center">
					<img src="{{ reponse.getUtilisateur() ? reponse.getUtilisateur().getUrlImageProfil() : 'default_avatar.jpg' }}" alt="Avatar" class="rounded-circle me-3" width="50" height="50">
					<div class="d-flex align-items-center">
						<h5 class="mb-0 mx-2 username-link">
							<a href="index.php?controller=utilisateur&methode=show&id_utilisateur={{ reponse.getUtilisateur() ? reponse.getUtilisateur().getId() : 0 }}" style="color:white;" class="text-decoration-none">
								{{ reponse.getUtilisateur() ? reponse.getUtilisateur().getPseudo() : 'Utilisateur inconnu' }}
							</a>
						</h5>
						<span class="mx-2" style="font-size: 1.2em;">•</span>
						<small>{{ reponse.datePublication | date('d M Y') }}</small>
						<span class="mx-2" style="font-size: 1.2em;">•</span>
						<small>
							Répond à 
							<a href="index.php?controller=utilisateur&methode=show&id_utilisateur={{ idAuteur }}">	
								@{{ pseudoAuteur ? pseudoAuteur : 'Utilisateur inconnu' }}
							</a>
						</small>
					</div>
				</div>
				<p class="mt-3">{{ reponse.valeur }}</p>
				<div class="d-flex justify-content-between mt-4">
					<div class="d-flex w-100 mt-4">
						<div class="me-auto">
							<button class="btn btn-sm me-2" style="background-color: #F2F2F2; color: #000;">
								<i class="bi bi-hand-thumbs-up"></i>
								{{ reponse.nbLikes }}
							</button>
							<button class="btn btn-sm me-2" style="background-color: #F2F2F2; color: #000;">
								<i class="bi bi-hand-thumbs-down"></i>
								{{ reponse.nbDislikes }}
							</button>
							<button class="btn btn-sm" style="background-color: #F2F2F2; color: #000;" onclick="ouvrirPopup()">
								<i class="bi bi-reply"></i>
								Répondre
							</button>
						</div>
						<div class="d-flex justify-content-end" style="flex-grow: 1;">
							<button class="btn btn-sm" style="background-color: #dc3545; color: white;">
								<i class="bi bi-flag"></i>
								Signaler
							</button>
						</div>
					</div>
				</div>
			</div>
		</div>
		{% if reponse.reponses is not empty %}
			{{ _self.afficherReponses(reponse.reponses, reponse.getUtilisateur() ? reponse.getUtilisateur().getId() : 0, reponse.getUtilisateur() ? reponse.getUtilisateur().getPseudo() : 'Utilisateur inconnu') }}
		{% endif %}
	{% endfor %}
{% endmacro %}


{% import _self as macros %}
{% extends 'base_template.html.twig' %}

{% block title %}
	VHS | Fil
{% endblock %}

{% block content %}
<div class="container-fluid bg-mydark text-white p-4 shadow mb-5" style="border-top: 5px solid #F2AC0F;">
		<div class="text-center">
			<h2 class="mb-3">{{ fil.titre }}</h2>
			<p class="">{{ fil.description }}</p>
		</div>
	</div>
<div class="container">
	{% for message in messages %}
		{% if message.idMessageParent is null %}
			<div class="card my-4 shadow-sm border-0 rounded-3">
				<div class="card-body p-4 bg-mydark text-white rounded">
					<div class="d-flex align-items-center">
						<img src="{{ message.getUtilisateur().getUrlImageProfil() }}" alt="Avatar" class="rounded-circle me-3" width="50" height="50">
						<div class="d-flex align-items-center">
							<h5 class="mb-0 mx-2">
								<a href="index.php?controller=utilisateur&methode=show&id_utilisateur={{message.getUtilisateur().getId() }}" style="color:white;" class="text-decoration-none">
									{{ message.getUtilisateur().getPseudo() ?: 'Utilisateur inconnu' }}
								</a>
							</h5>
							<span class="mx-2" style="font-size: 1.2em;">•</span>
							<small>{{ message.dateC | date('d M Y') }}</small>
						</div>
					</div>
					<p class="mt-3">{{ message.valeur }}</p>
					<div class="d-flex justify-content-between mt-4">
						<div class="d-flex w-100 mt-4">
							<div class="me-auto">
								<button class="btn btn-sm me-2" style="background-color: #F2F2F2; color: #000;">
									<i class="bi bi-hand-thumbs-up"></i>
									{{ reponse.nbLikes }}
								</button>
								<button class="btn btn-sm me-2" style="background-color: #F2F2F2; color: #000;">
									<i class="bi bi-hand-thumbs-down"></i>
									{{ reponse.nbDislikes }}
								</button>
								<button class="btn btn-sm" style="background-color: #F2F2F2; color: #000;" onclick="ouvrirPopup()">
									<i class="bi bi-reply"></i>
									Répondre
								</button>
							</div>
							<div class="d-flex justify-content-end" style="flex-grow: 1;">
								<button class="btn btn-sm" style="background-color: #dc3545; color: white;">
									<i class="bi bi-flag"></i>
									Signaler
								</button>
							</div>
						</div>
					</div>
				</div>
			</div>

			{% if message.reponses is not empty %}
	{{ macros.afficherReponses(message.reponses, message.getUtilisateur().getId(), message.getUtilisateur().getPseudo()) }}
{% endif %}

		{% endif %}
	{% endfor %}
</div>

<!-- Bouton flottant -->
<a href="index.php?controller=message&methode=create" class="btn btn-primary btn-floating position-fixed shadow"
   style="bottom: 70px; right: 40px; background-color: #F2AC0F; color: white; width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center; z-index: 1000;">
    <i class="bi bi-pencil" style="font-size: 1.5rem;"></i>
</a>

<!-- Pop-up Répondre -->
<div id="popupRepondre" class="popup d-none">
    <div class="popup-content p-4">
        <button class="close-popup btn btn-sm text-white position-absolute top-0 end-0 m-3" onclick="fermerPopup()">
            <i class="bi bi-x-lg"></i>
        </button>
        <div class="mb-3">
            <h5>D4rK_545uk3_du_93</h5>
            <p>
                Lorem ipsum dolor sit amet, consectetur adipiscing elit. Aenean commodo ligula eget dolor. 
                Aenean massa. Cum sociis natoque penatibus et magnis dis parturient montes...
            </p>
        </div>
        <textarea class="form-control mb-3" rows="4" maxlength="1000" placeholder="Répondre à D4rK_545uk3_du_93..."></textarea>
        <button class="btn btn-primary w-100" style="border-radius: 10px;">
            <i class="bi bi-send"></i> Envoyer
        </button>
    </div>
</div>

<script>
	function ouvrirPopup() {
		document.getElementById("popupRepondre").classList.remove("d-none");
	}

	function fermerPopup() {
		document.getElementById("popupRepondre").classList.add("d-none");
	}
</script>
{% endblock %}
